<!doctype html>
<html>
  <script src="transformer_asm.js"></script>
  <script src="transformer.js"></script>
  <script>
    // Utility function to convert Uint8Array to string.
    function ab2str(buf) {
      return String.fromCharCode.apply(null, new Uint16Array(buf.buffer));
    }
    
    // Utility function to convert string to Uint8Array.
    function str2ab(str) {
      var buf = new Uint8Array(str.length*2); // 2 bytes for each char
      var bufView = new Uint16Array(buf.buffer);
      for (var i=0, strLen=str.length; i<strLen; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return buf;
    }

    var IV_SIZE = 8;
    var testMessage = 'Good 1 2 3 4 5 6 7 8 9 0';

    var key = new Uint8Array(16);
    for (var i = 0; i < 16; i++) {
      key[i] = i;
    }
  
    var transformer = new Transformer();
    var ret = transformer.setKey(key);
    document.write('setKey call return:' + ret  + '<p/>');
    var plainText = str2ab(testMessage);
    var cipherText = transformer.transform(plainText);
    document.write('Transform call:' + cipherText  + '<p/>');

    var ret = transformer.setKey(key);
    document.write('setKey call return:' + ret  + '<p/>');
    var newText = transformer.restore(cipherText);
    var newMsg = ab2str(newText);
    document.write('Restore call:' + newMsg + '<p/>');

    if (newMsg == testMessage) {
      document.write('Message has been obfuscated and restored successfully.');
    } else {
      document.write('Failed in obfuscation/restore round trip transformation.');
    }
    
    transformer.dispose();
  </script>

</html>

