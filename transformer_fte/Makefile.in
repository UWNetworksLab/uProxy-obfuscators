CXX=@CXX@

THIRDPARTY_DIR = third_party

# TODO: no hardcoded vagrant paths
FTE_DIR=@libftedir@
FTE_INC_DIR=$(FTE_DIR)/include
FTE_LIB_DIR=$(FTE_DIR)/lib

GMP_DIR=@gmpdir@
GMP_INC_DIR=$(GMP_DIR)/include
GMP_LIB_DIR=$(GMP_DIR)/lib

RAPIDJSON_INC_DIR=$(THIRDPARTY_DIR)/rapidjson/include

SRC=src
EXPORTS=-s EXPORTED_FUNCTIONS="[\
    '_delete_transformer','_create_transformer',\
    '_set_key','_set_init_vector','_configure',\
    '_transform','_flush_transform','_restore']"
OPTIMIZATION_FLAGS = -O3
CXXFLAGS = $(OPTIMIZATION_FLAGS) -Wno-warn-absolute-paths -I$(GMP_INC_DIR) -I$(FTE_INC_DIR) -I$(RAPIDJSON_INC_DIR) $(EXPORTS) 
LDFLAGS = $(OPTIMIZATION_FLAGS) -Wno-warn-absolute-paths $(EXPORTS) -L$(FTE_LIB_DIR) -L$(GMP_LIB_DIR) -L$(FTE_LIB_DIR) -lgmp -lfte

TRANSFORMERJS = src/transformer.js
TARGET_FTEJS = fte.js

default: $(TARGET_FTEJS)

.PHONY: directories

FTEJS_OBJS = src/fte_transformer.o src/transformer.o

$(TARGET_FTEJS): $(FTEJS_OBJS)
	$(CXX) $(LDFLAGS) -o $@ $^
	cat $(TRANSFORMERJS) >> $(TARGET_FTEJS)
	
%.o: $(SRC)/%.cc
	$(CXX) -o $@ $< $(CXXFLAGS)

.PHONY: clean

clean:
	rm -f $(FTEJS_OBJS)
	rm -f $(TARGET_FTEJS)

