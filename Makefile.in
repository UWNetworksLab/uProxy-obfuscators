CXX=@CXX@

THIRDPARTY_DIR = third_party
DIST_DIR = dist

# TODO: no hardcoded vagrant paths
FTE_DIR=@libftedir@
FTE_INC_DIR=$(FTE_DIR)/include
FTE_LIB_DIR=$(FTE_DIR)/lib

GMP_DIR=@gmpdir@
GMP_INC_DIR=$(GMP_DIR)/include
GMP_LIB_DIR=$(GMP_DIR)/lib

RAPIDJSON_INC_DIR=$(THIRDPARTY_DIR)/rapidjson/include

REGEX2DFA_GIT = https://github.com/kpdyer/regex2dfa.git
REGEX2DFA_DIR = $(THIRDPARTY_DIR)/regex2dfa

EXPORTS=-s EXPORTED_FUNCTIONS="[\
    '_delete_transformer','_create_transformer',\
    '_set_key','_set_init_vector','_configure',\
    '_transform','_flush_transform','_restore']"
OPTIMIZATION_FLAGS = -O3
CXXFLAGS_ = $(CXXFLAGS) $(OPTIMIZATION_FLAGS) -Wall -I$(GMP_INC_DIR) -I$(FTE_INC_DIR) -I$(RAPIDJSON_INC_DIR) $(EXPORTS) 
LDFLAGS_ = $(LDFLAGS) $(OPTIMIZATION_FLAGS) -Wall $(EXPORTS) -L$(FTE_LIB_DIR) -L$(GMP_LIB_DIR) -L$(FTE_LIB_DIR) -lgmp -lfte

TRANSFORMERJS = src/transformer.js
TARGET_TESTFTEJS = bin/test.fte.js
TARGET_TESTRABBITJS = bin/test.rabbit.js
TARGET_FTEJS = html/js/utransformers.fte.js
TARGET_RABBITJS = html/js/utransformers.rabbit.js
TARGET_FTEREGEXES = html/js/regex2dfa.js
TARGET_REGEX2DFA = $(REGEX2DFA_DIR)/bin/regex2dfa

default: $(TARGET_FTEJS) $(TARGET_RABBITJS) $(TARGET_TESTFTEJS) $(TARGET_TESTRABBITJS)

.PHONY: directories

FTEJS_OBJS = src/fte_transformer.o \
             src/transformer_factory.o

RABBITJS_OBJS = src/rabbit_transformer.o \
                src/rabbit.o \
                src/transformer_factory.o

$(TARGET_FTEREGEXES): $(TARGET_REGEX2DFA)
	./contrib/build_dfas.py > $(TARGET_FTEREGEXES)

$(REGEX2DFA_DIR):
	cd $(THIRDPARTY_DIR) && git clone $(REGEX2DFA_GIT)
	
$(TARGET_REGEX2DFA): $(REGEX2DFA_DIR)
	cd $(REGEX2DFA_DIR) && ./configure && $(MAKE)

$(TARGET_FTEJS): $(FTEJS_OBJS)
	$(CXX) $(LDFLAGS_) -o $@ $^
	./contrib/postprocess_js.py fte

$(TARGET_RABBITJS): $(RABBITJS_OBJS)
	$(CXX) $(LDFLAGS_) -o $@ $^
	./contrib/postprocess_js.py rabbit

$(TARGET_TESTFTEJS): $(TARGET_FTEJS) $(TARGET_FTEREGEXES)
	cat $(TARGET_FTEJS) > $(TARGET_TESTFTEJS)
	cat html/js/common.js >> $(TARGET_TESTFTEJS)
	cat html/js/regex2dfa.js >> $(TARGET_TESTFTEJS)
	cat html/js/benchmark.settings.js >> $(TARGET_TESTFTEJS)
	cat html/js/benchmark.fte.js >> $(TARGET_TESTFTEJS)
	cat bin/test.fte.js.in >> $(TARGET_TESTFTEJS)

$(TARGET_TESTRABBITJS): $(TARGET_RABBITJS) $(TARGET_FTEREGEXES)
	cat $(TARGET_RABBITJS) > $(TARGET_TESTRABBITJS)
	cat html/js/common.js >> $(TARGET_TESTRABBITJS)
	cat html/js/regex2dfa.js >> $(TARGET_TESTRABBITJS)
	cat html/js/benchmark.settings.js >> $(TARGET_TESTRABBITJS)
	cat html/js/benchmark.rabbit.js >> $(TARGET_TESTRABBITJS)
	cat bin/test.rabbit.js.in >> $(TARGET_TESTRABBITJS)

$(DIST_DIR): $(TARGET_FTEJS) $(TARGET_RABBITJS) $(TARGET_FTEREGEXS)
	mkdir -p $(DIST_DIR)
	cp -f $(TARGET_FTEJS) $(DIST_DIR)
	cp -f $(TARGET_RABBITJS) $(DIST_DIR)
	cp -f $(TARGET_FTEREGEXES) $(DIST_DIR)
	cp -f html/js/common.js $(DIST_DIR)
	cp -fR typescript $(DIST_DIR)
	
%.o: %.cc
	$(CXX) -o $@ $< $(CXXFLAGS_)

.PHONY: clean

clean:
	rm -f $(FTEJS_OBJS)
	rm -f $(TARGET_FTEJS)
	rm -f $(RABBITJS_OBJS)
	rm -f $(TARGET_RABBITJS)
	rm -f $(TARGET_TESTFTEJS)
	rm -f $(TARGET_TESTRABBITJS)
	rm -f $(TARGET_FTEREGEXES)
	rm -rfv $(DIST_DIR)
